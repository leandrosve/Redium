import{c as P,r as c,m as y,j as e,U as H,b as g,A as S,B as v,a as k,k as E,l as T,i as R,T as A,L as _,S as q,M as O,d as V,R as Q,n as W}from"./index-BT9AESc7.js";import{T as Z,b as G,D as w,A as M,S as J,E as K,C as X,P as $,a as Y}from"./ActionMenu-CvBA3KtG.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["path",{d:"M20.5 14.9A9 9 0 0 0 9.1 3.5",key:"1iebmn"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M5.6 5.6C3 8.3 2.2 12.5 4 16l-2 6 6-2c3.4 1.8 7.6 1.1 10.3-1.7",key:"1ov8ce"}]],te=P("message-circle-off",ee);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]],L=P("message-circle",se),z=({fetchFunction:s,initialFetch:t=!0,initialData:n})=>{const[a,o]=c.useState(n),[l,r]=c.useState(t),[u,i]=c.useState(null),x=c.useCallback(async(d,p)=>{r(!0),i(null);const h=await d();if(r(!1),h.data){const j=h.data;o(p?C=>p(C,j):j);return}h.hasError&&i(h.error??"unknown_error")},[]),f=c.useCallback(()=>x(s),[x,s]),m=c.useCallback(d=>{o(d)},[]);return c.useEffect(()=>{t&&f()},[t]),{entity:a,loading:l,error:u,fetchEntity:f,setEntity:m}};function ne(){const s=Date.now().toString(36),t=Math.random().toString(36).slice(2,8);return`${s}-${t}`}const ae=({children:s,onCompleted:t})=>{const{user:n}=y(),[a,o]=c.useState(!1);return e.jsxs("div",{className:"relative rounded-3xl",children:[!n&&e.jsxs(e.Fragment,{children:[e.jsx("button",{"aria-label":"join",className:"rounded-3xl absolute t-0 l-0 bg-gray-500/5 z-10 h-full w-full cursor-pointer hover:bg-gray-500/10",onClick:()=>o(!0)}),e.jsx(H,{onClose:()=>o(!1),isOpen:a,onSaved:t})]}),s]})},oe=({parentId:s,autoFocus:t,inputId:n,onCancel:a,isSubmiting:o,comment:l,onSubmit:r,mode:u="create"})=>{const{t:i}=g(),{user:x}=y(),[f,m]=c.useState(l?.content??""),d=c.useMemo(()=>f.trim(),[f]),p=!x,h=u=="edit"||!p&&(!!d||s),j=()=>{m(""),a?.()};let C=null;u==="create"&&(C=x?e.jsx(S,{name:x.name,src:x.avatar,size:"sm",className:"mr-3"}):e.jsx(L,{}));const U=async b=>{b.preventDefault(),await r(d)&&(m(""),a?.())};return e.jsxs("form",{onSubmit:U,children:[e.jsx(Z,{disabled:!x,id:n,placeholder:i(u=="edit"?"comments.editPlaceholder":s?"comments.replyPlaceholder":"comments.placeholder"),innerClassName:`h-auto pr-12 ${u=="edit"?"text-sm":"text-md"}`,className:"dark:bg-transparent bg-content-100",maxLength:500,value:f,autoFocus:t,displayCharCount:!s,onChange:b=>m(b.target.value),icon:C}),h&&e.jsxs("div",{className:"flex align-center justify-end mt-2 gap-2 animate-scale-in duration-200",children:[e.jsx(v,{size:"sm",variant:"ghost",onClick:j,type:"reset",children:i("common.cancel")}),e.jsx(v,{size:"sm",variant:"solid",color:"secondary",type:"submit",loading:o,disabled:!d,children:i(s?"comments.reply":"comments.comment")})]})]})};class N extends G{static PATH="/post";static list(t){return this.get(`/${t}/comment`)}static async create(t,n,a,o){const l={content:n,parentId:a,...o,createdAt:new Date().toISOString()};return this.post(`/${t}/comment`,l,{delay:500})}static async update(t,n,a,o){const l={content:a,...o,updatedAt:new Date().toISOString()};return this.put(`/${t}/comment/${n}`,l,{delay:1e3})}static async delete(t,n){return this.del(`/${t}/comment/${n}`,{delay:1e3})}}const F=c.createContext({comments:[],loading:!1,error:null,addComment:()=>{},deleteComment:()=>{},updateComment:()=>{}}),re=({children:s,postId:t})=>{const{markCommentAsOwned:n}=k(),a=c.useCallback(()=>N.list(t),[t]),{loading:o,entity:l,setEntity:r,error:u}=z({fetchFunction:a,initialData:[]}),i=m=>{r(d=>d?[...d,m]:[m]),n(m.id)},x=m=>{r(d=>d?d.map(p=>p.id===m.id?m:p):[m]),n(m.id)},f=m=>{r(d=>d?d.filter(p=>p.id!==m):[])};return e.jsx(F.Provider,{value:{comments:l,loading:o,error:u,addComment:i,deleteComment:f,updateComment:x},children:s})},D=()=>c.useContext(F),le=({mode:s,parentId:t,comment:n,postId:a})=>{const{user:o}=y(),[l,r]=c.useState(!1),{addComment:u,updateComment:i}=D(),{toast:x}=E(),{t:f}=g(),m=c.useCallback(async d=>{if(!d||!o)return!1;r(!0);const p=s==="edit"&&n?await N.update(n.postId,n.id,d,o):await N.create(a,d,t??null,o);if(p.hasError){let h=f(`apiErrors.${p.error}`,{defaultValue:""});return h||(h=f("common.error")),x(h,"danger"),r(!1),!1}return s==="edit"?i(p.data):u(p.data),x(f(s==="edit"?"comments.saved":"comments.published")),r(!1),!0},[r,i,u,x]);return{isSubmiting:l,onSubmit:m}},I=({mode:s="create",postId:t,parentId:n,autoFocus:a,onCancel:o,onSuccess:l,comment:r})=>{const[u]=c.useState(ne()),{isSubmiting:i,onSubmit:x}=le({mode:s,postId:t,parentId:n,comment:r}),f=async m=>await x(m)?(l?.(),!0):!1;return e.jsx(ae,{onCompleted:()=>setTimeout(()=>document.getElementById(u)?.focus(),200),children:e.jsx(oe,{postId:t,parentId:n,autoFocus:a,inputId:u,onCancel:o,mode:s,comment:r,onSubmit:f,isSubmiting:i})})};function ce(s){const t=new Map,n=[];for(let a=0;a<s.length;a++){const o=s[a];t.set(o.id,{...o,children:[]})}for(let a=0;a<s.length;a++){const o=s[a],l=t.get(o.id);if(l)if(o.parentId){if(t.has(o.parentId)){const r=t.get(o.parentId);r&&r.children.push(l)}}else n.push(l)}return n.sort((a,o)=>{const l=new Date(a.createdAt).getTime();return new Date(o.createdAt).getTime()-l}),n}const ie=s=>c.useMemo(()=>ce(s),[s]);function me(s,t=2){const[n,a]=c.useState(!1);return c.useEffect(()=>{const o=s.current;if(!o)return;const l=window.getComputedStyle(o),u=parseFloat(l.lineHeight)*t;a(o.scrollHeight>u+1)},[s,t]),n}const de=({comment:s})=>{const t=c.useRef(null),[n,a]=c.useState(!1),[o,l]=c.useState(!1),r=me(t,2),{t:u}=g();return e.jsxs("div",{className:"text-sm text-foreground-200",children:[e.jsx("div",{ref:t,className:`text-sm text-foreground-200 break-all transition-all ${n?"":"line-clamp-2"}`,children:s.content}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[r&&e.jsx(v,{onClick:()=>a(i=>!i),variant:"link",size:"sm",className:"text-xs",children:u(n?"common.showLess":"common.showMore")}),e.jsx(v,{variant:"ghost",size:"sm",className:"text-xs text-foreground-100",leftIcon:e.jsx(L,{className:"h-4 w-4"}),onClick:()=>l(!0),children:u("comments.reply")})]}),o&&e.jsx("div",{className:"mt-1",children:e.jsx(I,{postId:s.postId,comment:null,parentId:s.id,autoFocus:!0,onCancel:()=>l(!1),onSuccess:()=>l(!1)})})]})},ue=5,B=({comment:s,nestingLevel:t=0,className:n})=>{const{isCommentOwned:a}=k(),{deleteComment:o}=D(),{toast:l}=E(),{t:r}=g(),u=a(s.id),[i,x]=c.useState(!1),{confirm:f}=T(),m=c.useCallback(async()=>{await N.delete(s.postId,s.id),o(s.id),l(r("comments.commentDeleted"))},[o,l]),d=c.useCallback(async()=>{await f({title:r("comments.deleteComment"),message:r("comments.deleteDescription"),confirmText:r("common.accept"),cancelText:r("common.cancel"),onConfirm:m})},[m,f]);return e.jsxs("div",{className:R("flex gap-2",n),children:[e.jsxs("div",{className:"flex flex-col items-center relative",children:[e.jsxs("div",{className:"relative",children:[e.jsx(S,{name:s.name,src:s.avatar,size:"sm",className:"shrink-0"}),t>0&&e.jsx("span",{className:"absolute h-[1px] comment-tree-line-horizontal w-5 -left-full top-1/2 -translate-y-1/2 bottom-0 ml-[7px] "})]}),!!s.children.length&&e.jsx("span",{className:"flex-1 comment-tree-line rounded-full w-[1px]  h-full  mt-2 mb-5"})]}),e.jsxs("div",{className:"flex flex-col gap-2 flex-1",children:[e.jsxs("div",{className:"flex gap-2 items-center font-bold text-foreground-200 text-sm",children:[e.jsxs("span",{className:"max-w-40 overflow-ellipsis line-clamp-1",children:[s.name," ",u&&`(${r("common.you")})`]}),e.jsx("span",{className:"select-none opacity-50",children:"•"}),e.jsx(w,{className:"text-xs",format:"time-ago",date:s.createdAt}),e.jsx(M,{onEdit:()=>x(!0),onDelete:d,size:"sm"})]}),i?e.jsx(I,{postId:s.postId,parentId:s.parentId,comment:s,autoFocus:!0,mode:"edit",onCancel:()=>x(!1),onSuccess:()=>x(!1)}):e.jsx(de,{comment:s}),t<ue&&s.children?.map(p=>e.jsx(B,{comment:p,nestingLevel:t+1},p.id))]})]})},xe=c.memo(B),fe=()=>{const{loading:s,comments:t,error:n}=D(),a=n&&n!="not_found";return e.jsxs("div",{className:"flex flex-col w-full gap-2 items-stretch bg-content-100 rounded-2xl p-4",children:[s&&e.jsx(J,{repeat:5,className:"h-20"}),!s&&!!t&&!a&&e.jsx("div",{className:"flex flex-col gap-4 ",children:e.jsx(pe,{comments:t})}),a&&e.jsx(K,{})]})},pe=({comments:s})=>{const t=ie(s),{t:n}=g();return e.jsxs("div",{className:"flex flex-col",children:[t.map(a=>e.jsx(xe,{comment:a,nestingLevel:0},a.id)),!t.length&&e.jsxs("div",{className:"text-center w-full p-5 font-bold text-sm text-foreground-200 relative",children:[e.jsx(te,{className:"h-14 w-14 opacity-10 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"}),n("comments.empty")]})]})},he=({postId:s})=>{const{t}=g();return e.jsx(re,{postId:s,children:e.jsxs("div",{className:"relative rounded-3xl",children:[e.jsx(I,{postId:s,comment:null}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("h3",{children:t("comments.comments")}),e.jsx(A,{content:t("extra.commentSection"),position:"right",children:e.jsx(X,{className:"h-4 w-4 text-foreground-200/50"})})]}),e.jsx(fe,{})]})]})})},ge=({items:s})=>e.jsx("nav",{className:"flex mb-6","aria-label":"Breadcrumb",children:e.jsx("ul",{className:"flex items-center text-sm",children:s.map((t,n)=>e.jsxs("li",{className:"flex items-center ",children:[n>0&&e.jsx("span",{className:"select-none text-foreground-200/60 mx-2",children:"/"}),n===s.length-1?e.jsx("span",{className:"text-foreground-200/60 font-medium max-w-40 overflow-hidden line-clamp-1 cursor-default",title:t.name,"aria-current":"page",children:t.name}):e.jsx(_,{to:t.to,className:"text-foreground-200 max-w-40 overflow-hidden line-clamp-1",children:t.name})]},t.to))})}),je=({id:s})=>{const{entity:t,error:n,loading:a}=z({fetchFunction:()=>$.detail(s),initialData:null});return c.useEffect(()=>{t&&(document.title=t?.title)},[t]),a?e.jsx(q,{fullPage:!0}):n||!t?e.jsx(O,{}):e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx(Ce,{post:t}),e.jsx("div",{className:"mt-8",children:e.jsx(he,{postId:t.id})})]})},Ce=({post:s})=>{const[t,n]=c.useState(s),{isPostOwned:a}=k(),o=a(t.id),{confirm:l}=T(),{toast:r}=E(),u=V(),{t:i}=g(),[x,f]=c.useState(!1),m=c.useCallback(p=>{n(p),f(!1)},[f]),d=c.useCallback(async()=>{if((await l({title:i("posts.deletePost"),message:i("posts.deleteDescription"),confirmText:i("common.accept"),cancelText:i("common.cancel"),onConfirm:async()=>await $.delete(t.id)})).hasError){r(i("common.error"),"danger");return}r(i("posts.postDeleted"),"info"),u(Q.POSTS)},[l,r,u,t.id]);return e.jsxs("div",{className:"relative",children:[e.jsx(ge,{items:[{to:"/posts",name:"Posts"},{to:"",name:t.title}]}),o&&e.jsx("div",{className:"absolute top-0 right-0",children:e.jsx(M,{onDelete:d,onEdit:()=>f(!0)})}),e.jsxs("div",{className:"flex gap-2 items-center font-bold text-foreground-200 text-sm flex-wrap max-sm",children:[e.jsx(S,{name:t.name,src:t.avatar,size:"sm"})," ",e.jsxs("span",{className:"max-w-40 overflow-ellipsis line-clamp-1",children:[t.name," ",o&&`(${i("common.you")})`,e.jsx("span",{className:"select-none opacity-50",children:"•"})]}),e.jsx(w,{date:t.createdAt,format:"date"}),t.updatedAt&&e.jsx(A,{content:e.jsx(w,{date:t.updatedAt,format:"date"}),position:"top",children:e.jsxs("span",{className:"text-xs",children:["(",i("common.edited"),")"]})})]}),e.jsx("h2",{className:"text-xl mt-4 font-bold",children:t.title}),e.jsx("p",{className:"mt-4 text-foreground-200",children:t.content}),e.jsx(Y,{isOpen:x,post:t,onSuccess:m,onClose:()=>f(!1)})]})},we=()=>{const{id:s}=W();return s?e.jsx("section",{className:"flex flex-col w-full max-w-5xl mt-10 gap-2 mb-20 items-stretch flex-1",children:e.jsx(je,{id:s})}):e.jsx(O,{})};export{we as default};
