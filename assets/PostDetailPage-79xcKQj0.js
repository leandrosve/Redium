import{c as P,r,m as T,j as e,U,b as j,A as S,B as N,a as k,k as E,l as A,i as H,L as R,S as _,M as O,d as q,R as V,T as W,n as Z}from"./index-CUUtpYDK.js";import{T as G,b as J,D as b,A as M,S as K,E as Q,P as $,a as X}from"./ActionMenu-B9kUYjSN.js";/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Y=[["path",{d:"M20.5 14.9A9 9 0 0 0 9.1 3.5",key:"1iebmn"}],["path",{d:"m2 2 20 20",key:"1ooewy"}],["path",{d:"M5.6 5.6C3 8.3 2.2 12.5 4 16l-2 6 6-2c3.4 1.8 7.6 1.1 10.3-1.7",key:"1ov8ce"}]],ee=P("message-circle-off",Y);/**
 * @license lucide-react v0.525.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const te=[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]],L=P("message-circle",te),z=({fetchFunction:s,initialFetch:t=!0,initialData:n})=>{const[a,o]=r.useState(n),[c,l]=r.useState(t),[m,d]=r.useState(null),p=r.useCallback(async(u,x)=>{l(!0),d(null);const h=await u();if(l(!1),h.data){const C=h.data;o(x?g=>x(g,C):C);return}h.hasError&&d(h.error??"unknown_error")},[]),f=r.useCallback(()=>p(s),[p,s]),i=r.useCallback(u=>{o(u)},[]);return r.useEffect(()=>{t&&f()},[t]),{entity:a,loading:c,error:m,fetchEntity:f,setEntity:i}};function se(){const s=Date.now().toString(36),t=Math.random().toString(36).slice(2,8);return`${s}-${t}`}const ne=({children:s,onCompleted:t})=>{const{user:n}=T(),[a,o]=r.useState(!1);return e.jsxs("div",{className:"relative rounded-3xl",children:[!n&&e.jsxs(e.Fragment,{children:[e.jsx("button",{"aria-label":"join",className:"rounded-3xl absolute t-0 l-0 bg-gray-500/5 z-10 h-full w-full cursor-pointer hover:bg-gray-500/10",onClick:()=>o(!0)}),e.jsx(U,{onClose:()=>o(!1),isOpen:a,onSaved:t})]}),s]})},ae=({user:s,parentId:t,autoFocus:n,inputId:a,onCancel:o,isSubmiting:c,disabled:l,comment:m,onSubmit:d,mode:p="create"})=>{const{t:f}=j(),[i,u]=r.useState(m?.content??""),x=r.useMemo(()=>i.trim(),[i]),h=p=="edit"||!l&&(!!x||t),C=()=>{u(""),o?.()};let g=null;p==="create"&&(g=s?e.jsx(S,{name:s.name,src:s.avatar,size:"sm",className:"mr-3"}):e.jsx(L,{}));const v=async y=>{y.preventDefault(),await d(x)&&(u(""),o?.())};return e.jsxs("form",{onSubmit:v,children:[e.jsx(G,{disabled:!s,id:a,placeholder:f(p=="edit"?"comments.editPlaceholder":t?"comments.replyPlaceholder":"comments.placeholder"),innerClassName:`h-auto pr-12 ${p=="edit"?"text-sm":"text-md"}`,className:"dark:bg-transparent bg-content-100",maxLength:500,value:i,autoFocus:n,displayCharCount:!t,onChange:y=>u(y.target.value),icon:g}),h&&e.jsxs("div",{className:"flex align-center justify-end mt-2 gap-2 animate-scale-in duration-200",children:[e.jsx(N,{size:"sm",variant:"ghost",onClick:C,type:"reset",children:f("common.cancel")}),e.jsx(N,{size:"sm",variant:"solid",color:"secondary",type:"submit",loading:c,disabled:!x,children:f(t?"comments.reply":"comments.comment")})]})]})};class w extends J{static PATH="/post";static list(t){return this.get(`/${t}/comment`)}static async create(t,n,a,o){const c={content:n,parentId:a,...o,createdAt:new Date().toISOString()};return this.post(`/${t}/comment`,c,{delay:500})}static async update(t,n,a,o){const c={content:a,...o,updatedAt:new Date().toISOString()};return this.put(`/${t}/comment/${n}`,c,{delay:1e3})}static async delete(t,n){return this.del(`/${t}/comment/${n}`,{delay:1e3})}}const B=r.createContext({comments:[],loading:!1,error:null,addComment:()=>{},deleteComment:()=>{},updateComment:()=>{}}),oe=({children:s,postId:t})=>{const{markCommentAsOwned:n}=k(),a=r.useCallback(()=>w.list(t),[t]),{loading:o,entity:c,setEntity:l,error:m}=z({fetchFunction:a,initialData:[]}),d=i=>{l(u=>u?[...u,i]:[i]),n(i.id)},p=i=>{l(u=>u?u.map(x=>x.id===i.id?i:x):[i]),n(i.id)},f=i=>{l(u=>u?u.filter(x=>x.id!==i):[])};return e.jsx(B.Provider,{value:{comments:c,loading:o,error:m,addComment:d,deleteComment:f,updateComment:p},children:s})},D=()=>r.useContext(B),I=({mode:s="create",postId:t,parentId:n,autoFocus:a,onCancel:o,onSuccess:c,comment:l})=>{const{user:m}=T(),[d]=r.useState(se()),[p,f]=r.useState(!1),{addComment:i,updateComment:u}=D(),{toast:x}=E(),{t:h}=j(),C=async g=>{if(!g||!m)return!1;f(!0);const v=s==="edit"&&l?await w.update(l.postId,l.id,g,m):await w.create(t,g,n??null,m);return v.hasError?(x(h("common.error")),!1):(s==="edit"?u(v.data):i(v.data),c?.(),x(h(s==="edit"?"comments.saved":"comments.published")),f(!1),!0)};return e.jsx(ne,{onCompleted:()=>setTimeout(()=>document.getElementById(d)?.focus(),200),children:e.jsx(ae,{user:m,postId:t,parentId:n,autoFocus:a,inputId:d,onCancel:o,disabled:!m,mode:s,comment:l,onSubmit:C,isSubmiting:p})})};function le(s){const t=new Map,n=[];for(let a=0;a<s.length;a++){const o=s[a];t.set(o.id,{...o,children:[]})}for(let a=0;a<s.length;a++){const o=s[a],c=t.get(o.id);if(c)if(o.parentId){if(t.has(o.parentId)){const l=t.get(o.parentId);l&&l.children.push(c)}}else n.push(c)}return n.sort((a,o)=>{const c=new Date(a.createdAt).getTime();return new Date(o.createdAt).getTime()-c}),n}const re=s=>r.useMemo(()=>le(s),[s]);function ce(s,t=2){const[n,a]=r.useState(!1);return r.useEffect(()=>{const o=s.current;if(!o)return;const c=window.getComputedStyle(o),m=parseFloat(c.lineHeight)*t;a(o.scrollHeight>m+1)},[s,t]),n}const ie=({comment:s})=>{const t=r.useRef(null),[n,a]=r.useState(!1),[o,c]=r.useState(!1),l=ce(t,2),{t:m}=j();return e.jsxs("div",{className:"text-sm text-foreground-200",children:[e.jsx("div",{ref:t,className:`text-sm text-foreground-200 break-all transition-all ${n?"":"line-clamp-2"}`,children:s.content}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[l&&e.jsx(N,{onClick:()=>a(d=>!d),variant:"link",size:"sm",className:"text-xs",children:m(n?"common.showLess":"common.showMore")}),e.jsx(N,{variant:"ghost",size:"sm",className:"text-xs text-foreground-100",leftIcon:e.jsx(L,{className:"h-4 w-4"}),onClick:()=>c(!0),children:m("comments.reply")})]}),o&&e.jsx("div",{className:"mt-1",children:e.jsx(I,{postId:s.postId,comment:null,parentId:s.id,autoFocus:!0,onCancel:()=>c(!1),onSuccess:()=>c(!1)})})]})},me=5,F=({comment:s,nestingLevel:t=0,className:n})=>{const{isCommentOwned:a}=k(),{deleteComment:o}=D(),{toast:c}=E(),{t:l}=j(),m=a(s.id),[d,p]=r.useState(!1),{confirm:f}=A(),i=r.useCallback(async()=>{await w.delete(s.postId,s.id),o(s.id),c(l("comments.commentDeleted"))},[o,c]),u=r.useCallback(async()=>{await f({title:l("comments.deleteComment"),message:l("comments.deleteDescription"),confirmText:l("common.accept"),cancelText:l("common.cancel"),onConfirm:i})},[i,f]);return e.jsxs("div",{className:H("flex gap-2",n),children:[e.jsxs("div",{className:"flex flex-col items-center relative",children:[e.jsxs("div",{className:"relative",children:[e.jsx(S,{name:s.name,src:s.avatar,size:"sm",className:"shrink-0"}),t>0&&e.jsx("span",{className:"absolute h-[1px] comment-tree-line-horizontal w-5 -left-full top-1/2 -translate-y-1/2 bottom-0 ml-[7px] "})]}),!!s.children.length&&e.jsx("span",{className:"flex-1 comment-tree-line rounded-full w-[1px]  h-full  mt-2 mb-5"})]}),e.jsxs("div",{className:"flex flex-col gap-2 flex-1",children:[e.jsxs("div",{className:"flex gap-2 items-center font-bold text-foreground-200 text-sm",children:[e.jsxs("span",{className:"max-w-40 overflow-ellipsis line-clamp-1",children:[s.name," ",m&&`(${l("common.you")})`]}),e.jsx("span",{className:"select-none opacity-50",children:"•"}),e.jsx(b,{className:"text-xs",format:"time-ago",date:s.createdAt}),m&&e.jsx(M,{onEdit:()=>p(!0),onDelete:u})]}),d?e.jsx(I,{postId:s.postId,parentId:s.parentId,comment:s,autoFocus:!0,mode:"edit",onCancel:()=>p(!1),onSuccess:()=>p(!1)}):e.jsx(ie,{comment:s}),t<me&&s.children?.map(x=>e.jsx(F,{comment:x,nestingLevel:t+1},x.id))]})]})},de=r.memo(F),ue=()=>{const{loading:s,comments:t,error:n}=D(),a=n&&n!="not_found";return e.jsxs("div",{className:"flex flex-col w-full gap-2 items-stretch bg-content-100 rounded-2xl p-4",children:[s&&e.jsx(K,{repeat:5,className:"h-20"}),!s&&!!t&&!a&&e.jsx("div",{className:"flex flex-col gap-4 ",children:e.jsx(xe,{comments:t})}),a&&e.jsx(Q,{})]})},xe=({comments:s})=>{const t=re(s),{t:n}=j();return e.jsxs("div",{className:"flex flex-col",children:[t.map(a=>e.jsx(de,{comment:a,nestingLevel:0},a.id)),!t.length&&e.jsxs("div",{className:"text-center w-full p-5 font-bold text-sm text-foreground-200 relative",children:[e.jsx(ee,{className:"h-14 w-14 opacity-10 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"}),n("comments.empty")]})]})},fe=({postId:s})=>{const{t}=j();return e.jsx(oe,{postId:s,children:e.jsxs("div",{className:"relative rounded-3xl",children:[e.jsx(I,{postId:s,comment:null}),e.jsxs("div",{className:"mt-4",children:[e.jsx("h3",{className:"mb-2",children:t("comments.comments")}),e.jsx(ue,{})]})]})})},pe=({items:s})=>e.jsx("nav",{className:"flex mb-6","aria-label":"Breadcrumb",children:e.jsx("ul",{className:"flex items-center text-sm",children:s.map((t,n)=>e.jsxs("li",{className:"flex items-center ",children:[n>0&&e.jsx("span",{className:"select-none text-foreground-200/60 mx-2",children:"/"}),n===s.length-1?e.jsx("span",{className:"text-foreground-200/60 font-medium max-w-40 overflow-hidden line-clamp-1 cursor-default",title:t.name,"aria-current":"page",children:t.name}):e.jsx(R,{to:t.to,className:"text-foreground-200 max-w-40 overflow-hidden line-clamp-1",children:t.name})]},t.to))})}),he=({id:s})=>{const{entity:t,error:n,loading:a}=z({fetchFunction:()=>$.detail(s),initialData:null});return r.useEffect(()=>{t&&(document.title=t?.title)},[t]),a?e.jsx(_,{fullPage:!0}):n||!t?e.jsx(O,{}):e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsx(ge,{post:t}),e.jsx("div",{className:"mt-8",children:e.jsx(fe,{postId:t.id})})]})},ge=({post:s})=>{const[t,n]=r.useState(s),{isPostOwned:a}=k(),o=a(t.id),{confirm:c}=A(),{toast:l}=E(),m=q(),{t:d}=j(),[p,f]=r.useState(!1),i=r.useCallback(x=>{n(x),f(!1)},[f]),u=r.useCallback(async()=>{if((await c({title:d("posts.deletePost"),message:d("posts.deleteDescription"),confirmText:d("common.accept"),cancelText:d("common.cancel"),onConfirm:async()=>await $.delete(t.id)})).hasError){l(d("common.error"),"danger");return}l(d("posts.postDeleted"),"info"),m(V.POSTS)},[c,l,m,t.id]);return e.jsxs("div",{className:"relative",children:[e.jsx(pe,{items:[{to:"/posts",name:"Posts"},{to:"",name:t.title}]}),o&&e.jsx("div",{className:"absolute top-0 right-0",children:e.jsx(M,{onDelete:u,onEdit:()=>f(!0)})}),e.jsxs("div",{className:"flex gap-2 items-center font-bold text-foreground-200 text-sm flex-wrap max-sm",children:[e.jsx(S,{name:t.name,src:t.avatar,size:"sm"})," ",e.jsxs("span",{className:"max-w-40 overflow-ellipsis line-clamp-1",children:[t.name," ",o&&`(${d("common.you")})`,e.jsx("span",{className:"select-none opacity-50",children:"•"})]}),e.jsx(b,{date:t.createdAt,format:"date"}),t.updatedAt&&e.jsx(W,{content:e.jsx(b,{date:t.updatedAt,format:"date"}),position:"top",children:e.jsxs("span",{className:"text-xs",children:["(",d("common.edited"),")"]})})]}),e.jsx("h2",{className:"text-xl mt-4 font-bold",children:t.title}),e.jsx("p",{className:"mt-4 text-foreground-200",children:t.content}),e.jsx(X,{isOpen:p,post:t,onSuccess:i,onClose:()=>f(!1)})]})},Ne=()=>{const{id:s}=Z();return s?e.jsx("section",{className:"flex flex-col w-full max-w-5xl mt-10 gap-2 mb-20 items-stretch flex-1",children:e.jsx(he,{id:s})}):e.jsx(O,{})};export{Ne as default};
